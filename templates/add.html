{% extends "base.html" %}

{% block title %}Add New Entry{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">Add New Entry</h1>

    <div class="card p-6 mb-8">
        <form method="POST" action="/add">
            <div class="mb-4">
                <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                <select id="category" name="category" class="select" required>
                    <option value="" disabled selected>Select a category</option>
                    <option value="riddle">Riddle</option>
                    <option value="joke">Joke</option>
                    <option value="idiom">Idiom</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="question" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Question</label>
                <textarea id="question" name="question" rows="3" class="input" required placeholder="Enter the question or first part"></textarea>
            </div>

            <div class="mb-6">
                <label for="answer" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Answer</label>
                <textarea id="answer" name="answer" rows="3" class="input" required placeholder="Enter the answer or second part"></textarea>
            </div>

            <div class="flex justify-end">
                <button type="submit" class="btn btn-primary">Add Entry</button>
            </div>
        </form>
    </div>

    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">使用AI生成内容</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
            让AI为您生成内容。选择类别、数量和模型，然后点击下方按钮。
        </p>

        <div class="mb-4">
            <label for="ai-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">类别</label>
            <select id="ai-category" class="select">
                <option value="riddle">谜语</option>
                <option value="joke">笑话</option>
                <option value="idiom">成语</option>
            </select>
        </div>

        <div class="mb-4">
            <label for="ai-count" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">生成数量</label>
            <select id="ai-count" class="select">
                <option value="1">1条</option>
                <option value="3" selected>3条</option>
                <option value="5">5条</option>
                <option value="10">10条</option>
            </select>
        </div>

        <div class="mb-4">
            <label for="ai-model" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">AI模型</label>
            <select id="ai-model" class="select">
                <option value="deepseek-chat">DeepSeek Chat</option>
                <option value="qianwen-max">千问Max</option>
                <option value="openrouter:anthropic/claude-3-haiku">Claude 3 Haiku</option>
            </select>
        </div>

        <div class="mb-4">
            <button id="generate-btn" class="btn btn-secondary">生成内容</button>
        </div>

        <div id="ai-result" class="hidden">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">生成的内容</label>
                <div id="generated-items" class="space-y-4"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('generate-btn').addEventListener('click', function() {
        const category = document.getElementById('ai-category').value;
        const count = parseInt(document.getElementById('ai-count').value);
        const model = document.getElementById('ai-model').value;
        const resultDiv = document.getElementById('ai-result');
        const itemsContainer = document.getElementById('generated-items');

        // 显示加载状态
        resultDiv.classList.remove('hidden');
        itemsContainer.innerHTML = '<div class="p-3 border rounded-md bg-gray-50 dark:bg-gray-800">正在生成内容，请稍候...</div>';

        // 根据类别构建提示
        let prompt = '';
        switch(category) {
            case 'riddle':
                prompt = `请生成${count}个有趣的谜语，每个谜语包含问题和答案。格式要求：
1. 每个谜语必须包含问题和答案
2. 问题和答案之间用"答案："分隔
3. 每个谜语之间用"---"分隔
4. 不要有编号
5. 直接给出谜语内容，不要有多余的解释`;
                break;
            case 'joke':
                prompt = `请生成${count}个有趣的笑话，每个笑话包含问题和答案。格式要求：
1. 每个笑话必须包含问题和答案
2. 问题和答案之间用"答案："分隔
3. 每个笑话之间用"---"分隔
4. 不要有编号
5. 直接给出笑话内容，不要有多余的解释`;
                break;
            case 'idiom':
                prompt = `请生成${count}个成语及其含义。格式要求：
1. 每个成语必须包含成语本身和其含义
2. 成语和含义之间用"含义："分隔
3. 每个成语之间用"---"分隔
4. 不要有编号
5. 直接给出成语内容，不要有多余的解释`;
                break;
        }

        // 调用LLM API
        fetch('/api/llm/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: model,
                prompt: prompt,
                temperature: 0.8,
                max_tokens: 2000
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                itemsContainer.innerHTML = `<div class="p-3 border rounded-md bg-red-50 dark:bg-red-900 text-red-600 dark:text-red-200">错误: ${data.error}</div>`;
                return;
            }

            // 处理生成的内容
            let content = data.text || '';
            if (!content) {
                itemsContainer.innerHTML = '<div class="p-3 border rounded-md bg-red-50 dark:bg-red-900 text-red-600 dark:text-red-200">生成内容为空</div>';
                return;
            }

            // 分割多个条目
            const items = content.split('---').map(item => item.trim()).filter(item => item);

            // 清空容器
            itemsContainer.innerHTML = '';

            // 添加每个生成的条目
            items.forEach((item, index) => {
                let question = '';
                let answer = '';

                if (category === 'riddle' || category === 'joke') {
                    const parts = item.split('答案：');
                    if (parts.length > 1) {
                        question = parts[0].trim();
                        answer = parts[1].trim();
                    } else {
                        question = item;
                        answer = '';
                    }
                } else if (category === 'idiom') {
                    const parts = item.split('含义：');
                    if (parts.length > 1) {
                        question = parts[0].trim();
                        answer = parts[1].trim();
                    } else {
                        question = item;
                        answer = '';
                    }
                }

                // 创建条目元素
                const itemElement = document.createElement('div');
                itemElement.className = 'p-4 border rounded-md bg-gray-50 dark:bg-gray-800';
                itemElement.innerHTML = `
                    <div class="mb-2">
                        <strong>问题:</strong> ${question}
                    </div>
                    <div class="mb-3">
                        <strong>答案:</strong> ${answer}
                    </div>
                    <div class="flex justify-end">
                        <button class="use-item-btn btn btn-sm btn-primary" data-question="${encodeURIComponent(question)}" data-answer="${encodeURIComponent(answer)}">使用此内容</button>
                    </div>
                `;

                itemsContainer.appendChild(itemElement);
            });

            // 为每个"使用此内容"按钮添加事件监听器
            document.querySelectorAll('.use-item-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const question = decodeURIComponent(this.getAttribute('data-question'));
                    const answer = decodeURIComponent(this.getAttribute('data-answer'));

                    // 填充表单
                    document.getElementById('question').value = question;
                    document.getElementById('answer').value = answer;
                    document.getElementById('category').value = category;

                    // 滚动到表单
                    document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
                });
            });
        })
        .catch(error => {
            itemsContainer.innerHTML = `<div class="p-3 border rounded-md bg-red-50 dark:bg-red-900 text-red-600 dark:text-red-200">请求失败: ${error.message}</div>`;
        });
    });
</script>
{% endblock %}
